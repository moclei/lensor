%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#4a5568', 'primaryTextColor': '#fff', 'lineColor': '#718096', 'secondaryColor': '#667eea'}}}%%

flowchart TB
    subgraph Activation["üñ±Ô∏è Extension Activation"]
        A[User clicks<br>extension icon] --> B[Service Worker:<br>chrome.action.onClicked]
        B --> C[Set active=true<br>via Crann]
        C --> D[UI becomes visible]
    end

    subgraph Capture["üì∏ Tab Capture (captureVisibleTab)"]
        D --> E[UI calls captureTab<br>action via Crann RPC]
        E --> F["Service Worker:<br>chrome.tabs.captureVisibleTab()<br>‚úÖ No recording indicator!"]
        F --> G[Return data URL<br>~12MB PNG string]
    end

    subgraph Convert["üîÑ Conversion"]
        G --> H[new Image<br>src = dataUrl]
        H --> I["createImageBitmap()<br>‚Üí ImageBitmap ~8MB"]
        I --> J[Data URL garbage collected]
    end

    subgraph Process["‚öôÔ∏è Processing"]
        J --> K{Has black<br>borders?}
        K -->|Yes| L[createImageBitmap<br>crop borders]
        L --> M["sourceBitmap.close()<br>‚úÖ Free ~8MB"]
        K -->|No| N[Use original]
        M --> O["Close previous bitmap<br>‚úÖ Memory managed"]
        N --> O
        O --> P[Store in React state]
    end

    subgraph Render["üé® Canvas Rendering"]
        P --> Q{Fisheye ON?}
        Q -->|No| R[drawImage direct<br>to mainCanvas 400√ó400]
        Q -->|Yes| S[drawImage to<br>interCanvas]
        S --> T[WebGL: upload<br>as texture]
        T --> U[Apply fisheye<br>shader]
        U --> V[Draw to<br>mainCanvas]
        R --> W["getImageData()<br>sample center pixel"]
        V --> W
        W --> X[Update color<br>and palettes]
    end

    subgraph Recapture["üîÑ Recapture Loop"]
        X --> Y{Page changed?}
        Y -->|"Scroll/Resize/<br>DOM mutation"| Z["Trigger recapture<br>(rate limit: 2/sec)"]
        Z --> E
        Y -->|No| AA[Wait for<br>user interaction]
        AA --> Y
    end

    style F fill:#48bb78,stroke:#38a169,color:#fff
    style I fill:#ed8936,stroke:#dd6b20,color:#fff
    style M fill:#48bb78,stroke:#38a169,color:#fff
    style O fill:#48bb78,stroke:#38a169,color:#fff
    style X fill:#9f7aea,stroke:#805ad5,color:#fff
